from .PPField import PPField
from dolfin import Function, FunctionAssigner
from ..core.spaces import NSSpacePoolMixed, NSSpacePoolSplit, NSSpacePoolSegregated

class Velocity(PPField):
    def convert(self, pp, spaces, problem):
        # Hack to get given u in whatever format it has,
        # avoiding circular reference to this field
        u = super(Velocity, self).convert(pp, spaces, problem)
        d = spaces.d

        if not isinstance(u, Function):
            if not hasattr(self, "_u"):
                # FIXME: This doesn't work for mixed spaces! What should we pass
                #        as the second argument to FunctionAssigner then?
                #        Or do we need a two-level copying?
                self._assigner = FunctionAssigner(spaces.V, [spaces.U]*d)
                #self._assigner = FunctionAssigner(spaces.V, spaces.Ubc)
                self._u = Function(spaces.V)

            self._assigner.assign(self._u, [u[i] for i in range(d)])
            u = self._u

        assert isinstance(u, Function)
        return u
