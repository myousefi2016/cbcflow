from .PPField import PPField
from dolfin import Function, FunctionAssigner, error
from ..core.spaces import NSSpacePoolMixed, NSSpacePoolSplit, NSSpacePoolSegregated

class Velocity(PPField):
    def convert(self, pp, spaces, problem):
        # Hack to get given u in whatever format it has,
        # avoiding circular reference to this field
        u = super(Velocity, self).convert(pp, spaces, problem)
        d = spaces.d

        if not isinstance(u, Function):
            if not hasattr(self, "_u"):
                self._u = Function(spaces.V)

                if isinstance(spaces, NSSpacePoolMixed):
                    self._assigner = FunctionAssigner(spaces.V, spaces.W.sub(0))
                elif isinstance(spaces, NSSpacePoolSegregated):
                    self._assigner = FunctionAssigner(spaces.V, [spaces.U]*d)
                else:
                    error("It doesnt make sense to create a function assigner for a split space.")

            if isinstance(spaces, NSSpacePoolMixed):
                # Hack: u is a ListTensor, get the first scalar item
                u0 = u.operands()[0]
                # Hack: u0 is an Indexed, get the underlying mixed function
                w = u0.operands()[0]
                assert w.shape() == (d+1,)
                # FIXME: Neither of these work:
                # Test by running  cd demo/; ./womersley2d.py CoupledPicard
                #us = [w.sub(0).sub(i) for i in range(d)]
                us = [w[i] for i in range(d)]

            elif isinstance(spaces, NSSpacePoolSegregated):
                us = [u[i] for i in range(d)]

            print us
            print type(us)
            print map(type,us)

            self._assigner.assign(self._u, us)
            u = self._u

        assert isinstance(u, Function)
        return u
